DROP TABLE IF EXISTS JAT_MCV_UNIVERSO_MODELADO_201712_201810;

CREATE TABLE IF NOT EXISTS
	JAT_MCV_UNIVERSO_MODELADO_201712_201810 AS
(
SELECT
	T1.LLAVE_UNIVERSAL_20,
	T1.FECHA,
	T1.CLIENTE,
	T1.RFC,
	T1.LINEA,
	T1.FOLIO_BC,
	T1.FECHA_BC,
	T2.LABEL,
	T1.REVOLVENTE
FROM
	JAT_MCV_UNIVERSO_MODELADO2 T1 -- CONTIENE TODOS LOS CRÉDITOS DE PEQUEÑA SIN FILTRO DE LABEL, FECHA Y FECHA_BC
LEFT JOIN
	JEA_MCV_UNIVERSO_TMP T2
ON
	T1.LLAVE_UNIVERSAL_20 = T2.LLAVE_UNIVERSAL_20 AND T1.FECHA = T2.FECHA
WHERE
	T1.FECHA BETWEEN 201712 AND 201805
	AND (SUBSTR(T1.FECHA,1,4)-YEAR(T1.FECHA_BC))*12 + SUBSTR(T1.FECHA,5,2) - MONTH(T1.FECHA_BC) BETWEEN 0 AND 4
	AND T1.FECHA_BC IS NOT NULL
)
UNION ALL
(
SELECT
	T1.LLAVE_UNIVERSAL_20,
	T1.FECHA,
	T1.CLIENTE,
	T1.RFC,
	T1.LINEA,
	T1.FOLIO_BC,
	T1.FECHA_BC,
	T2.LABEL,
	T1.REVOLVENTE
FROM
	JAT_MCV_UNIVERSO_201806_201810 T1 -- CONTIENE TODOS LOS CRÉDITOS DE PEQUEÑA CON FILTRO DE LABEL, FECHA(201) Y FECHA_BC
LEFT JOIN
	JEA_MCV_UNIVERSO_TMP T2
ON
	T1.LLAVE_UNIVERSAL_20 = T2.LLAVE_UNIVERSAL_20 AND T1.FECHA = T2.FECHA
WHERE
	T1.FECHA_BC IS NOT NULL
)
;

ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY LLAVE_UNIVERSAL_20(LLAVE_UNIVERSAL_20);
ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY FECHA(FECHA);
ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY CLIENTE(CLIENTE);
ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY RFC(RFC);
ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY LINEA(LINEA);
ALTER TABLE JAT_MCV_UNIVERSO_MODELADO_201712_201810 ADD KEY FOLIO_BC(FOLIO_BC);

SELECT FECHA, LABEL, COUNT(*) FROM JAT_MCV_UNIVERSO_MODELADO_201712_201810 GROUP BY 1, 2;