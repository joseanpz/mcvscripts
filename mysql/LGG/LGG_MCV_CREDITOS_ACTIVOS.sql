--  Lorena García González
--  Agosto 20, 2018
--  MCV: Variables - Copia Crédito Activos con Banderas. Es la misma tabla que la oficial, solo que esta tiene la banderas necesarias.


USE DBMYMWORK;

DROP TABLE IF EXISTS LGG_MCV_CREDITOS_ACTIVOS;

CREATE TABLE IF NOT EXISTS LGG_MCV_CREDITOS_ACTIVOS AS 
SELECT
	* ,
	CASE 
		WHEN TIPOOTORGANTE = 'BANCO' THEN 1
		ELSE 0 END AS BK_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS BK_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS BK_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS BK_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS BK_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS BK_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'BANCO' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
		ELSE 0 END AS BK_OTHER_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'ARRENDADORA' THEN 1
		ELSE 0 END AS LSE_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS LSE_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS LSE_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS LSE_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS LSE_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS LSE_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'ARRENDADORA' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
	ELSE 0 END AS LSE_OTHER_OP_ACC, 
	CASE 
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' THEN 1
		ELSE 0 END AS UN_CRE_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS UN_CRE_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS UN_CRE_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS UN_CRE_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS UN_CRE_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS UN_CRE_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'UNION DE CREDITO' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
		ELSE 0 END AS UN_CRE_OTHER_OP_ACC,	
	CASE 
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' THEN 1
		ELSE 0 END AS OTHER_FIN_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS OTHER_FIN_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS OTHER_FIN_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS OTHER_FIN_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS OTHER_FIN_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS OTHER_FIN_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'OTRAS FINANCIERAS' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
		ELSE 0 END AS OTHER_FIN_OTHER_OP_ACC,	
		CASE 
		WHEN TIPOOTORGANTE = 'GOBIERNO' THEN 1
		ELSE 0 END AS GBN_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS GBN_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS GBN_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS GBN_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS GBN_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS GBN_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'GOBIERNO' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
	ELSE 0 END AS GBN_OTHER_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'BANREGIO' THEN 1
		ELSE 0 END AS BRG_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS BRG_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS BRG_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS BRG_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS BRG_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS BRG_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'BANREGIO' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
	ELSE 0 END AS BRG_OTHER_OP_ACC,
		CASE 
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' THEN 1
		ELSE 0 END AS BRG_LSE_OP_ACC,
	CASE
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO = '1302' THEN 1 
		ELSE 0 END AS BRG_LSE_PQ_OP_ACC, --  Quirografario
	CASE 
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO IN('1301','1305','1307','1309','1310','1340','1341') THEN 1
		ELSE 0 END AS BRG_LSE_CS_OP_ACC, --  Crédito Simple.
	CASE 
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO IN('1300','1303','1304','1308','1311','1320','1322','3011''3012','3231','6270')  THEN 1
		ELSE 0 END AS BRG_LSE_LSG_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO IN('1308','1323','1324','1380','2303','6105','6250','6280')  THEN 1
		ELSE 0 END AS BRG_LSE_R_OP_ACC,	
	CASE 
		WHEN 	TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO = '6260' THEN 1
		ELSE 0 END AS BRG_LSE_CF_OP_ACC,
	CASE 
		WHEN TIPOOTORGANTE = 'ARREND BANREGIO' AND TIPOCREDITO IS NOT NULL 
		AND TIPOCREDITO NOT IN ('1302','1301','1305','1307','1309','1310','1340','1341','1300','1303','1304','1308','1311','1320','1322',
								'3011''3012','3231','6270'     ,'1308','1323','1324','1380','2303','6105','6250','6280','6260') THEN 1
	ELSE 0 END AS BRG_LSE_OTHER_OP_ACC	
FROM 
	JEA_MCV_CREDITOS_ACTIVOS;

	
ALTER TABLE LGG_MCV_CREDITOS_ACTIVOS ADD INDEX LLAVE(RFC);
ALTER TABLE LGG_MCV_CREDITOS_ACTIVOS ADD INDEX LLAVE2(FOLIO);
ALTER TABLE LGG_MCV_CREDITOS_ACTIVOS ADD INDEX LLAVE3(FECHACONSULTA);

--  Actualizamos el Saldo
UPDATE LGG_MCV_CREDITOS_ACTIVOS 
SET SALDOINICIAL = IF(TIPOCREDITO = '1380' AND SALDOINICIAL = 0 ,(DIAS119+DIAS179+DIAS29+DIAS59+DIAS89+DIASMAS180+VIGENTEC)/0.45,
IF(TIPOCREDITO = '6280' AND SALDOINICIAL = 0,(DIAS119+DIAS179+DIAS29+DIAS59+DIAS89+DIASMAS180+VIGENTEC)/0.15,SALDOINICIAL));

--  CABIAMOS EL FORMATO DE FECHA CONSULTA
UPDATE LGG_MCV_CREDITOS_ACTIVOS 
SET FECHAAPERTURA = STR_TO_DATE(IF(FECHAAPERTURA IS NULL,NULL,FECHAAPERTURA),'%Y%m%d');	