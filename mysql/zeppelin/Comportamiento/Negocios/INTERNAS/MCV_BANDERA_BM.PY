---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------ BANDERA BUENO MALO ----------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

%hive
DROP TABLE IF EXISTS dbriskdatamart.JAT_MCV_BANDERA_BM__${FECHA_CALIFICACION};

CREATE TABLE dbriskdatamart.JAT_MCV_BANDERA_BM__${FECHA_CALIFICACION}
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
LOCATION 's3://boi-banregio/datalake/data/InteligenciaRiesgos/M&M/MZM/MCV/JAT_MCV_BANDERA_BM__${FECHA_CALIFICACION}' AS
SELECT
    T1.RFC,
    T1.FECHA,
    T1.UEN_SEGMENTACION_CLIENTE,
    MIN(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 6 THEN NULL
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 6 THEN IF(T2.CARTERA_VENCIDA > 0, (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2), 7)
        END
        ) AS MES_CV,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 6 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 6 THEN IF(T2.CARTERA_VENCIDA > 0,1,0)
            ELSE 0
        END
        )
    , 0) AS CV,
    MIN(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 9 THEN NULL
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 9 THEN IF(T2.CARTERA_VENCIDA > 0, (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2), 10)
        END
        ) AS MES_CV_09M,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 9 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 9 THEN IF(T2.CARTERA_VENCIDA > 0,1,0)
            ELSE 0
        END
        )
    , 0) AS CV_09M,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 6 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 6 THEN IF(T2.DIAS_ATRASO IS NULL,0,T2.DIAS_ATRASO)
            ELSE 0
        END
        )
    , 0) AS `MAX_ATR@06M`,
    MIN(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 6 THEN NULL
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 6 THEN IF(T2.DIAS_ATRASO >= 60, (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2), 7)
        END
        ) AS `MES_60+@06M`,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 6 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 6 THEN IF(T2.DIAS_ATRASO >= 60,1,0)
            ELSE 0
        END
        )
    , 0) AS `60+@06M`,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 9 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 9 THEN IF(T2.DIAS_ATRASO IS NULL,0,T2.DIAS_ATRASO)
            ELSE 0
        END
        )
    , 0) AS `MAX_ATR@09M`,
    MIN(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 9 THEN NULL
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 9 THEN IF(T2.DIAS_ATRASO >= 60, (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2), 10)
        END
        ) AS `MES_60+@09M`,
    GREATEST(
    MAX(
        CASE
            WHEN (SUBSTR('${FECHA_CALIFICACION}',1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR('${FECHA_CALIFICACION}',5,2)-SUBSTR(T1.FECHA,5,2) < 9 THEN 0
            WHEN (SUBSTR(T2.FECHA,1,4)-SUBSTR(T1.FECHA,1,4))*12+SUBSTR(T2.FECHA,5,2)-SUBSTR(T1.FECHA,5,2) BETWEEN 0 AND 9 THEN IF(T2.DIAS_ATRASO >= 60,1,0)
            ELSE 0
        END
        )
    , 0) AS `60+@09M`
FROM
    (SELECT RFC, FECHA, UEN_SEGMENTACION_CLIENTE, SUM(CARTERA_VENCIDA) AS CARTERA_VENCIDA FROM DBRISKDATAMART.TBL_CARTERACREDITICIA WHERE MIS <> 0 AND FECHA <= '${FECHA_CALIFICACION}' GROUP BY RFC, FECHA, UEN_SEGMENTACION_CLIENTE) T1
INNER JOIN
    (SELECT RFC, FECHA, SUM(CARTERA_VENCIDA) AS CARTERA_VENCIDA, MAX(DIAS_ATRASO) AS DIAS_ATRASO FROM DBRISKDATAMART.TBL_CARTERACREDITICIA WHERE MIS <> 0 AND FECHA <= '${FECHA_CALIFICACION}' GROUP BY RFC, FECHA) T2
ON
    T1.RFC = T2.RFC
GROUP BY
    T1.RFC,
    T1.FECHA,
    T1.UEN_SEGMENTACION_CLIENTE
;

SELECT * FROM dbriskdatamart.JAT_MCV_BANDERA_BM__${FECHA_CALIFICACION} LIMIT 100;