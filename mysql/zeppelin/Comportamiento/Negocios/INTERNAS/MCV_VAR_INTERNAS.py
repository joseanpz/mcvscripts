%hive

DROP TABLE IF EXISTS dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO1__${FECHA_CALIFICACION};

CREATE TABLE dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO1__${FECHA_CALIFICACION}
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
LOCATION 's3://boi-banregio/datalake/data/InteligenciaRiesgos/M&M/MZM/MCV/JAT_MCV_VAR_INTERNAS_PASO1__${FECHA_CALIFICACION}' AS

SELECT
	T1.RFC,
	-- T1.LINEA,
	T1.FECHA,
	-- T1.FECHAULTIMOCAMBIO,
	SUM(CASE WHEN T1.Clas_AT IN ('CCC','CCI','Factoraje','PQ','RCR','Revolvente Varios','TDCE') THEN 1 ELSE 0 END) AS CTAS_REVOLVENTES,
	SUM(CASE WHEN T1.Clas_AT IN ('CCC','CCI','Factoraje','PQ','RCR','Revolvente Varios','TDCE') THEN T1.SALDO ELSE 0 END) AS SDO_REVOLVENTES,
	-- T1.ID_ULTIMOMOVIMIENTOLIN,
	SUM(CASE WHEN T1.Clas_AT IN ('CCC','CCI','Factoraje','PQ','RCR','Revolvente Varios','TDCE') THEN T2.CANTIDADOTORGADADESPUES ELSE 0 END) AS LINEA_REVOLVENTE,
	SUM(CASE WHEN T1.Clas_AT IN ('CCC','CCI','Factoraje','PQ','RCR','Revolvente Varios','TDCE') THEN T1.SALDO ELSE 0 END)/NULLIF(SUM(CASE WHEN T1.Clas_AT IN ('CCC','CCI','Factoraje','PQ','RCR','Revolvente Varios','TDCE') THEN T2.CANTIDADOTORGADADESPUES ELSE 0 END),0) AS UTIL_INTERNA
FROM
	(
	SELECT
		A.RFC,
		A.LINEA,
		A.FECHA,
		A.SALDO,
		A.CLAS_AT,
		A.FECHAULTIMOCAMBIO,
		MAX(B.ID_MOVIMIENTOLIN) AS ID_ULTIMOMOVIMIENTOLIN
	FROM
		(
		SELECT
			X.RFC,
			X.LINEA,
			X.FECHA,
			X.SALDO,
			Z.CLAS_AT,
			MAX(CASE WHEN YEAR(Y.FECHACAMBIO)*100+MONTH(Y.FECHACAMBIO) <= X.FECHA THEN Y.FECHACAMBIO ELSE NULL END) AS FECHAULTIMOCAMBIO
			
		FROM
			dbriskdatamart.Tbl_CarteraCrediticia X
		LEFT JOIN
			dbriskdatamart.Tbl_MovimientoLineas Y
		ON
			X.LINEA = Y.LINEAORIGINAL
		LEFT JOIN
			dbriskdatamart.Tbl_Cat_Alerta_Temp Z
		ON
			X.TIPO_DE_CREDITO = Z.TIPO_DE_CREDITO
		WHERE
		    X.MIS <> 0
            AND X.FECHA <= ${FECHA_CALIFICACION}
		GROUP BY
			X.RFC,
			X.LINEA,
			X.FECHA,
			X.SALDO,
			Z.CLAS_AT
		) A
	LEFT JOIN
		dbriskdatamart.Tbl_MovimientoLineas B
	ON
		A.LINEA = B.LINEAORIGINAL
		AND A.FECHAULTIMOCAMBIO = B.FECHACAMBIO
	GROUP BY
		A.RFC,
		A.LINEA,
		A.FECHA,
		A.SALDO,
		A.CLAS_AT,
		A.FECHAULTIMOCAMBIO
	) T1
LEFT JOIN
	dbriskdatamart.Tbl_MovimientoLineas T2
ON
	T1.ID_ULTIMOMOVIMIENTOLIN = T2.Id_movimientolin
GROUP BY
	T1.RFC,
	-- T1.LINEA,
	T1.FECHA
;

DROP TABLE IF EXISTS dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO2__${FECHA_CALIFICACION};

CREATE TABLE dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO2__${FECHA_CALIFICACION}
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
LOCATION 's3://boi-banregio/datalake/data/InteligenciaRiesgos/M&M/MZM/MCV/JAT_MCV_VAR_INTERNAS_PASO2__${FECHA_CALIFICACION}' AS

SELECT
	T1.RFC,
	T1.FECHA,
	T1.CTAS_REVOLVENTES,
	T1.SDO_REVOLVENTES,
	T1.LINEA_REVOLVENTE,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 00 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T00,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 01 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T01,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 02 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T02,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 03 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T03,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 04 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T04,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 05 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T05,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 06 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T06,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 07 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T07,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 08 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T08,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 09 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T09,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 10 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T10,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 11 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T11,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) = 12 THEN T2.UTIL_INTERNA ELSE NULL END) AS UTIL_INTERNA_T12,
	LEAST(MIN(CASE WHEN T2.FECHA <= T1.FECHA AND T2.UTIL_INTERNA >= 0.80 THEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) ELSE NULL END), 54) AS MSS_DESDE_UTIL_80MAS,
	LEAST(MIN(CASE WHEN T2.FECHA <= T1.FECHA AND T2.UTIL_INTERNA >= 0.85 THEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) ELSE NULL END), 54) AS MSS_DESDE_UTIL_85MAS,
	LEAST(MIN(CASE WHEN T2.FECHA <= T1.FECHA AND T2.UTIL_INTERNA >= 0.90 THEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) ELSE NULL END), 54) AS MSS_DESDE_UTIL_90MAS,
	LEAST(MIN(CASE WHEN T2.FECHA <= T1.FECHA AND T2.UTIL_INTERNA >= 0.95 THEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) ELSE NULL END), 54) AS MSS_DESDE_UTIL_95MAS
	
FROM
	dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO1__${FECHA_CALIFICACION} T1
LEFT JOIN
	dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO1__${FECHA_CALIFICACION} T2
ON
	T1.RFC = T2.RFC
GROUP BY
	T1.RFC,
	T1.FECHA,
	T1.CTAS_REVOLVENTES,
	T1.SDO_REVOLVENTES,
	T1.LINEA_REVOLVENTE
;

DROP TABLE IF EXISTS dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO3__${FECHA_CALIFICACION};

CREATE TABLE dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO3__${FECHA_CALIFICACION}
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
LOCATION 's3://boi-banregio/datalake/data/InteligenciaRiesgos/M&M/MZM/MCV/JAT_MCV_VAR_INTERNAS_PASO3__${FECHA_CALIFICACION}' AS

SELECT
	T1.RFC,
	T1.FECHA,
	T1.CTAS_REVOLVENTES,
	T1.SDO_REVOLVENTES,
	T1.LINEA_REVOLVENTE,
	T1.UTIL_INTERNA_T00,
	T1.UTIL_INTERNA_T01,
	T1.UTIL_INTERNA_T02,
	T1.UTIL_INTERNA_T03,
	T1.UTIL_INTERNA_T04,
	T1.UTIL_INTERNA_T05,
	T1.UTIL_INTERNA_T06,
	T1.UTIL_INTERNA_T07,
	T1.UTIL_INTERNA_T08,
	T1.UTIL_INTERNA_T09,
	T1.UTIL_INTERNA_T10,
	T1.UTIL_INTERNA_T11,
	T1.UTIL_INTERNA_T12,
	T1.MSS_DESDE_UTIL_80MAS,
	T1.MSS_DESDE_UTIL_85MAS,
	T1.MSS_DESDE_UTIL_90MAS,
	T1.MSS_DESDE_UTIL_95MAS,
	
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U00M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U01M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U02M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U03M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U04M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U05M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U06M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U07M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U08M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U09M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U10M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U11M,
	MAX(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MAX_UTIL_INTERNA_U12M,
	
	-- MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U00M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U01M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U02M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U03M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U04M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U05M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U06M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U07M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U08M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U09M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U10M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U11M,
	MIN(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	MIN_UTIL_INTERNA_U12M,
	
	-- AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U00M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U01M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U02M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U03M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U04M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U05M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U06M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U07M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U08M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U09M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U10M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U11M,
	AVG(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 THEN T2.UTIL_INTERNA_T00 ELSE NULL END)	AS	AVG_UTIL_INTERNA_U12M,
	
	-- SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 THEN (01 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U00,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 THEN (02 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (02 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U01,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 THEN (03 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (03 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U02,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 THEN (04 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (04 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U03,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 THEN (05 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (05 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U04,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 THEN (06 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (06 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U05,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 THEN (07 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (07 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U06,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 THEN (08 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (08 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U07,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 THEN (09 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (09 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U08,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 THEN (10 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (10 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U09,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 THEN (11 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (11 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U10,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 THEN (12 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (12 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U11,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 THEN (13 - (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END) / SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (13 -  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MAS_UTIL_INTERNA_U12,
	
	-- SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 00 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U00,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 01 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U01,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 02 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U02,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 03 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U03,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 04 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U04,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 05 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U05,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 06 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U06,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 07 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U07,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 08 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U08,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 09 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U09,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 10 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U10,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 11 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U11,
	SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 THEN (01 + (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2)) * T2.UTIL_INTERNA_T00 ELSE NULL END)/ SUM(CASE WHEN (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2) BETWEEN 00 AND 12 AND T2.UTIL_INTERNA_T00 IS NOT NULL THEN (01 +  (SUBSTR(T1.FECHA,1,4)-SUBSTR(T2.FECHA,1,4))*12+SUBSTR(T1.FECHA,5,2)-SUBSTR(T2.FECHA,5,2))  ELSE NULL END) AS AVG_PND_MENOS_UTIL_INTERNA_U12

FROM
	dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO2__${FECHA_CALIFICACION} T1
LEFT JOIN
	dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO2__${FECHA_CALIFICACION} T2
ON
	T1.RFC = T2.RFC
GROUP BY
	T1.RFC,
	T1.FECHA,
	T1.CTAS_REVOLVENTES,
	T1.SDO_REVOLVENTES,
	T1.LINEA_REVOLVENTE,
	T1.UTIL_INTERNA_T00,
	T1.UTIL_INTERNA_T01,
	T1.UTIL_INTERNA_T02,
	T1.UTIL_INTERNA_T03,
	T1.UTIL_INTERNA_T04,
	T1.UTIL_INTERNA_T05,
	T1.UTIL_INTERNA_T06,
	T1.UTIL_INTERNA_T07,
	T1.UTIL_INTERNA_T08,
	T1.UTIL_INTERNA_T09,
	T1.UTIL_INTERNA_T10,
	T1.UTIL_INTERNA_T11,
	T1.UTIL_INTERNA_T12,
	T1.MSS_DESDE_UTIL_80MAS,
	T1.MSS_DESDE_UTIL_85MAS,
	T1.MSS_DESDE_UTIL_90MAS,
	T1.MSS_DESDE_UTIL_95MAS
;

DROP TABLE IF EXISTS dbriskdatamart.JAT_MCV_VAR_INTERNAS__${FECHA_CALIFICACION};

CREATE TABLE dbriskdatamart.JAT_MCV_VAR_INTERNAS__${FECHA_CALIFICACION}
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
LOCATION 's3://boi-banregio/datalake/data/InteligenciaRiesgos/M&M/MZM/MCV/JAT_MCV_VAR_INTERNAS__${FECHA_CALIFICACION}' AS

SELECT
	T1.*,
	
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T01,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T02,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T03,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T04,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T05,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T06,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T07,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T08,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T09,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T10,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T10 - T1.UTIL_INTERNA_T11) / T1.UTIL_INTERNA_T11 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T11,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T10 - T1.UTIL_INTERNA_T11) / T1.UTIL_INTERNA_T11 > 0.05, 1, 0) + IF((T1.UTIL_INTERNA_T11 - T1.UTIL_INTERNA_T12) / T1.UTIL_INTERNA_T12 > 0.05, 1, 0) AS NUM_INC_UTIL_INTERNA_T12,
	
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T01,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T02,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T03,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T04,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T05,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T06,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T07,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T08,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T09,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T10,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T10 - T1.UTIL_INTERNA_T11) / T1.UTIL_INTERNA_T11 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T11,
	IF((T1.UTIL_INTERNA_T00 - T1.UTIL_INTERNA_T01) / T1.UTIL_INTERNA_T01 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T01 - T1.UTIL_INTERNA_T02) / T1.UTIL_INTERNA_T02 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T02 - T1.UTIL_INTERNA_T03) / T1.UTIL_INTERNA_T03 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T03 - T1.UTIL_INTERNA_T04) / T1.UTIL_INTERNA_T04 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T04 - T1.UTIL_INTERNA_T05) / T1.UTIL_INTERNA_T05 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T05 - T1.UTIL_INTERNA_T06) / T1.UTIL_INTERNA_T06 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T06 - T1.UTIL_INTERNA_T07) / T1.UTIL_INTERNA_T07 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T07 - T1.UTIL_INTERNA_T08) / T1.UTIL_INTERNA_T08 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T08 - T1.UTIL_INTERNA_T09) / T1.UTIL_INTERNA_T09 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T09 - T1.UTIL_INTERNA_T10) / T1.UTIL_INTERNA_T10 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T10 - T1.UTIL_INTERNA_T11) / T1.UTIL_INTERNA_T11 < -0.05, 1, 0) + IF((T1.UTIL_INTERNA_T11 - T1.UTIL_INTERNA_T12) / T1.UTIL_INTERNA_T12 < -0.05, 1, 0) AS NUM_DEC_UTIL_INTERNA_T12

FROM
	dbriskdatamart.JAT_MCV_VAR_INTERNAS_PASO3__${FECHA_CALIFICACION} T1
;

SELECT * FROM dbriskdatamart.JAT_MCV_VAR_INTERNAS__${FECHA_CALIFICACION} LIMIT 100;