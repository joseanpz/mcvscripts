-- JOSE DE JESUS ALMANZA TREJO
-- CONTEOS CARTERA DE NEGOCIOS - ROLL RATES
-- 20180517


-- SE CREA UNA COPIA DEL ARCHIVO DE CASTIGOS Y SE CREA UNA LLAVE UNIVERSAL
DROP VIEW IF EXISTS cartera.JAE_VIEW_MCV_CASTIGOS;

CREATE OR REPLACE VIEW 
	cartera.JAE_VIEW_MCV_CASTIGOS AS
SELECT
	LPAD(CONCAT(LINEA,MONEDA),25,'0') AS LLAVE_UNIVERSAL,
	MIN(ANIOMES) AS FECHA_CASTIGO
FROM
	cartera.Tbl_Castigos
WHERE
	PORTAFOLIO = 'Comercial'
GROUP BY
	1
;

-- ALTER TABLE DBMYMWORK.JAT_MCV_CASTIGOS ADD KEY LLAVE0(LLAVE_UNIVERSAL);

SELECT * FROM DBMYMWORK.JAT_MCV_CASTIGOS;

SELECT @FECHA_MAX:=(SELECT MAX(FECHA) FROM cartera."Tbl_CarteraCrediticia";

DROP TABLE IF EXISTS cartera."JAE_MCV_NEGOCIOS_CONTEO_ROLL_RATE";

-- CREATE TABLE IF NOT EXISTS
--	DBMYMWORK.JAT_MCV_NEGOCIOS_CONTEO_ROLL_RATE AS
SELECT
	-- T3.FECHA,
	T3.RANGO_DA00,
	
	CASE
		WHEN T3.RANGO_DA01 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,1,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 1 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA01
	END AS RANGO_DA01,
		
	CASE
		WHEN T3.RANGO_DA02 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,2,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 2 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA02
	END AS RANGO_DA02,
	
	CASE
		WHEN T3.RANGO_DA03 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,3,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 3 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA03
	END AS RANGO_DA03,
	
	CASE
		WHEN T3.RANGO_DA04 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,4,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 4 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA04
	END AS RANGO_DA04,

	CASE
		WHEN T3.RANGO_DA05 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,5,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 5 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA05
	END AS RANGO_DA05,
	
	CASE
		WHEN T3.RANGO_DA06 IS NULL THEN
			CASE
				WHEN TIMESTAMPADD(MONTH,6,STR_TO_DATE(CONCAT(T3.FECHA,'01'),'%Y%m%d')) > STR_TO_DATE(CONCAT(@FECHA_MAX,'01'),'%Y%m%d') THEN NULL
				WHEN (FLOOR(T4.FECHA_CASTIGO/100) - FLOOR(T3.FECHA/100))*12 + MOD(T4.FECHA_CASTIGO, 100) - MOD(T3.FECHA, 100) <= 6 THEN '99: CASTIGO'
				ELSE '98: LIQUIDA'
			END
		ELSE RANGO_DA06
	END AS RANGO_DA06,
	
	COUNT(*) AS REGISTROS,
	ROUND(SUM(SALDO),2) AS SALDO,
	ROUND(SUM(CARTERA_VENCIDA),2) AS CARTERA_VENCIDA

	INTO
		cartera."JAE_MCV_NEGOCIOS_CONTEO_ROLL_RATE"
FROM
	(
	SELECT
		T1.LLAVE_UNIVERSAL,
		T1.FECHA,
		T1.SALDO,
		T1.CARTERA_VENCIDA,
		
		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CERO
		CASE
			WHEN T1.DIAS_ATRASO IS NULL OR T1.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T1.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T1.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T1.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T1.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T1.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END AS RANGO_DA00,

		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES UNO
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 1
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA01,

		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES DOS
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 2
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA02,
		
		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES TRES
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 3
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA03,
		
		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CUATRO
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 4
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA04,

		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CINCO
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 5
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA05,

		-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES SEIS
		(
		SELECT
			CASE
				WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
				WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
				ELSE '07: 180+ DÍAS'
			END
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 6
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS RANGO_DA06,

		-- SE GENERA LA ETIQUETA DE IDENTIFICACIÓN CLIENTES DE NEGOCIOS DURANTE 12 MESES SIGUIENTES
		(
		SELECT
			MIN(CASE
				WHEN CLASS15='Negocios' THEN 1
				ELSE 0 END)
		FROM
			DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T2
		WHERE
			T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
			AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) BETWEEN 0 AND 12
			AND T2.CLASS15 IN ('Negocios','Empresarial')
		) AS NEGOCIOS_S12M
		
	FROM
		DBMYMWORK.JAT_BKT_CARTERA_CREDITICIA_201201_201804 T1
	WHERE
		T1.FECHA BETWEEN 201401 AND 201804
		AND T1.CLASS15 = 'Negocios'
		AND T1.MIS NOT IN ('AutoSummit','Master Lease', 'Agave')
		AND T1.LINEA NOT IN ('191001680030') -- PRESENTA ERROR DE DUPLICIDAD EN FEB2014
	) T3
LEFT JOIN
	DBMYMWORK.JAT_MCV_CASTIGOS T4
ON
	T3.LLAVE_UNIVERSAL = T4.LLAVE_UNIVERSAL
WHERE
	NEGOCIOS_S12M = 1
GROUP BY
	1, 2, 3, 4, 5, 6, 7 -- , 8
;

SELECT * FROM DBMYMWORK.JAT_MCV_NEGOCIOS_CONTEO_ROLL_RATE;