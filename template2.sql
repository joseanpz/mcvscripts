SELECT
	T1.LLAVE_UNIVERSAL,
	T1.FECHA,
	T1.SALDO,
	T1.CARTERA_VENCIDA,
	
	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CERO
	CASE
		WHEN T1.DIAS_ATRASO IS NULL OR T1.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
		WHEN T1.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
		WHEN T1.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T1.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T1.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T1.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
		ELSE '07: 180+ DÍAS'
	END AS RANGO_DA00,

	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES UNO
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 1
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA01,

	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES DOS
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 2
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA02,
	
	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES TRES
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 3
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA03,
	
	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CUATRO
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 4
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA04,

	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES CINCO
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 5
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA05,

	-- SE CALCULA EL RANGO DE DÍAS DE ATRASO EN EL MES SEIS
	(
	SELECT
		CASE
			WHEN T2.DIAS_ATRASO IS NULL OR T2.DIAS_ATRASO = 0 THEN '00: CERO DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 1 AND 29 THEN '01: 001 A 029 DÍAS'
			WHEN T2.DIAS_ATRASO BETWEEN 30 AND 179 THEN CONCAT(LPAD(FLOOR(T2.DIAS_ATRASO/30)+1,2,'0'),': ',LPAD(FLOOR(T2.DIAS_ATRASO/30)*30,3,'0'),' - ',LPAD((FLOOR(T2.DIAS_ATRASO/30)+1)*30-1,3,'0'),' DÍAS')
			ELSE '07: 180+ DÍAS'
		END
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) = 6
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS RANGO_DA06,

	-- SE GENERA LA ETIQUETA DE IDENTIFICACIÓN CLIENTES DE NEGOCIOS DURANTE 12 MESES SIGUIENTES
	(
	SELECT
		MIN(CASE
			WHEN CLASS15='Negocios' THEN 1
			ELSE 0 END)
	FROM
		cartera."Tbl_CarteraCrediticia" T2
	WHERE
		T2.LLAVE_UNIVERSAL = T1.LLAVE_UNIVERSAL
		AND (FLOOR(T2.FECHA/100) - FLOOR(T1.FECHA/100))*12 + MOD(T2.FECHA,100) - MOD(T1.FECHA,100) BETWEEN 0 AND 12
		AND T2.CLASS15 IN ('Negocios','Empresarial')
	) AS NEGOCIOS_S12M
	
FROM
	cartera."Tbl_CarteraCrediticia" T1
WHERE
	T1.FECHA BETWEEN 201401 AND 201804
	AND T1.CLASS15 = 'Negocios'
	AND T1.MIS NOT IN ('AutoSummit','Master Lease', 'Agave')
	AND T1.LINEA NOT IN ('191001680030') -- PRESENTA ERROR DE DUPLICIDAD EN FEB2014